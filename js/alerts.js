(async function(){const r=await fetch('data/convocatorias.json');const items=await r.json().catch(()=>[]);const wrap=document.createElement('section');wrap.className='section';wrap.innerHTML=`<h2>Convocatorias y alertas</h2><p>Revisa el estado y activa recordatorios por correo y WhatsApp.</p><div class="cards" id="conv-cards"></div>`;if(!hostSec){ document.getElementById('content').appendChild(wrap); }const cards=wrap.querySelector('#conv-cards');function days(d){const n=new Date(),t=new Date(d+'T00:00:00');return Math.ceil((t-n)/86400000)}function card(it){const dA=days(it.abre),dC=days(it.cierra);const status=dA>0?`Abre en ${dA} día(s)`: (dC>=0?`Abierta — cierra en ${dC} día(s)`:'Cerrada');const el=document.createElement('article');el.className='card';el.innerHTML=`<h3>📅 ${it.programa} — ${it.region}</h3><p><strong>Abre:</strong> ${it.abre} · <strong>Cierra:</strong> ${it.cierra}</p><p><strong>Estado:</strong> ${status}</p><p><a class="btn ghost" href="${it.url}" target="_blank" rel="noopener">Ver bases</a></p><form class="notify"><label>Email <input name="email" type="email" required placeholder="tucorreo@..."></label><label>WhatsApp (opcional, +569...) <input name="whats" pattern="^\+?\d{8,15}$" placeholder="+569..."></label><button class="btn" type="submit">🔔 Activar alerta</button></form>`;el.querySelector('form.notify').addEventListener('submit',async e=>{e.preventDefault();const fd=new FormData(e.target);const payload={email:fd.get('email'),whatsapp:fd.get('whats'),programa:it.programa,abre:it.abre,cierra:it.cierra,url:it.url,tz:Intl.DateTimeFormat().resolvedOptions().timeZone};try{const res=await fetch('/.netlify/functions/notify',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});if(res.ok) alert('✅ Alerta activada.'); else alert('⚠️ No se pudo activar la alerta.');}catch(err){alert('⚠️ Error de red: '+err)}});return el}items.forEach(it=>cards.appendChild(card(it)));})();